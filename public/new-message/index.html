<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leave a Message · Neon Nights</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-dark text-light">
    <div class="container py-5">
      <a class="text-decoration-none text-secondary" href="../">&larr; Back to Home</a>
      <h1 class="display-5 fw-bold mt-4">Leave a Message</h1>
      <p class="lead text-secondary">
        Drop a quick hello for the rooftop crew. This form validates locally for now, so nothing gets sent just yet.
      </p>

      <div class="card bg-transparent border border-secondary-subtle shadow-sm">
        <div class="card-body">
          <form id="messageForm" novalidate>
            <div class="mb-3">
              <label class="form-label" for="usernameInput">Username</label>
              <input
                id="usernameInput"
                name="username"
                type="text"
                class="form-control bg-dark text-light border-secondary"
                placeholder="Pam"
                required
              />
              <div class="invalid-feedback">Please enter your username.</div>
            </div>

            <div class="mb-3">
              <label class="form-label" for="countryInput">Country</label>
              <input
                id="countryInput"
                name="country"
                type="text"
                class="form-control bg-dark text-light border-secondary"
                placeholder="Anguilla"
                required
              />
              <div class="invalid-feedback">Country is required.</div>
            </div>

            <div class="mb-4">
              <label class="form-label" for="messageInput">Message</label>
              <textarea
                id="messageInput"
                name="message"
                class="form-control bg-dark text-light border-secondary"
                rows="4"
                placeholder="Say hello..."
                required
              ></textarea>
              <div class="invalid-feedback">Please share a quick message.</div>
            </div>

            <div class="d-flex align-items-center gap-3">
              <button class="btn btn-primary" type="submit">Send Message</button>
              <div id="formStatus" class="small text-secondary"></div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('messageForm');
      const inputs = ['usernameInput', 'countryInput', 'messageInput'].map((id) => document.getElementById(id));
      const statusEl = document.getElementById('formStatus');

      function setStatus(message, type = 'secondary') {
        statusEl.textContent = message;
        statusEl.className = `small text-${type}`;
      }

      inputs.forEach((input) => {
        input.addEventListener('input', () => {
          if (input.value.trim()) {
            input.classList.remove('is-invalid');
          }
          setStatus('');
        });
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        let hasErrors = false;

        inputs.forEach((input) => {
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            hasErrors = true;
          } else {
            input.classList.remove('is-invalid');
          }
        });

        if (hasErrors) {
          setStatus('Please fill out all fields before sending.', 'warning');
          return;
        }

        const payload = {
          username: inputs[0].value.trim(),
          country: inputs[1].value.trim(),
          message: inputs[2].value.trim(),
        };

        try {
          setStatus('Sending your message…', 'info');
          const response = await fetch('/api/guestbook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(data.error || 'Unable to send your message.');
          }

          setStatus('Message posted! Redirecting to the guestbook…', 'success');
          form.reset();
          inputs.forEach((input) => input.classList.remove('is-invalid'));
          setTimeout(() => {
            window.location.href = '../guestbook/';
          }, 1200);
        } catch (error) {
          console.error(error);
          setStatus(error.message || 'Unable to send your message. Please try again later.', 'danger');
        }
      });
    </script>
  </body>
</html>
